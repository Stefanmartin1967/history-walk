(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const qe="HistoryWalkDB",ye=4;let z;function D(){return new Promise((e,t)=>{if(z&&z.version===ye)return e(z);const n=indexedDB.open(qe,ye);n.onerror=o=>{console.error("Erreur d'initialisation de la base de donn√©es:",o),t(new Error("Erreur d'initialisation IndexedDB."))},n.onsuccess=o=>{z=o.target.result,e(z)},n.onupgradeneeded=o=>{const r=o.target.result;r.objectStoreNames.contains("poiUserData")||r.createObjectStore("poiUserData",{keyPath:["mapId","poiId"]}).createIndex("mapId_index","mapId",{unique:!1}),r.objectStoreNames.contains("savedCircuits")||r.createObjectStore("savedCircuits",{keyPath:"id"}).createIndex("mapId_index","mapId",{unique:!1}),r.objectStoreNames.contains("appState")||r.createObjectStore("appState",{keyPath:"key"}),r.objectStoreNames.contains("modifications")||(r.objectStoreNames.contains("modifications")&&r.deleteObjectStore("modifications"),r.createObjectStore("modifications",{autoIncrement:!0}))}})}async function O(e){const t=await D();return new Promise((n,o)=>{const a=t.transaction("appState","readonly").objectStore("appState").get(e);a.onsuccess=()=>n(a.result?a.result.value:void 0),a.onerror=s=>o(s.target.error)})}async function I(e,t){const n=await D();return new Promise((o,r)=>{const s=n.transaction("appState","readwrite").objectStore("appState").put({key:e,value:t});s.onsuccess=()=>o(),s.onerror=l=>r(l.target.error)})}async function te(e){const t=await D();return new Promise((n,o)=>{const a=t.transaction("poiUserData","readonly").objectStore("poiUserData").index("mapId_index").getAll(e);a.onsuccess=()=>{const s={};a.result.forEach(l=>{const{mapId:d,poiId:u,...p}=l;s[u]=p}),n(s)},a.onerror=s=>o(s.target.error)})}async function de(e,t,n){const o=await D();return new Promise((r,a)=>{const l=o.transaction("poiUserData","readwrite").objectStore("poiUserData"),d=l.get([e,t]);d.onsuccess=()=>{const p={...d.result||{},...n,mapId:e,poiId:t},m=l.put(p);m.onsuccess=()=>r(),m.onerror=g=>a(g.target.error)},d.onerror=u=>a(u.target.error)})}async function _e(e,t){const n=await D();return new Promise((o,r)=>{if(t.length===0)return o();const a=n.transaction("poiUserData","readwrite"),s=a.objectStore("poiUserData");a.oncomplete=()=>o(),a.onerror=l=>r(l.target.error),t.forEach(l=>{const{poiId:d,data:u}=l,p=s.get([e,d]);p.onsuccess=()=>{const g={...p.result||{},...u,mapId:e,poiId:d};s.put(g)}})})}async function K(e){const t=await D();return new Promise((n,o)=>{const a=t.transaction("savedCircuits","readonly").objectStore("savedCircuits").index("mapId_index").getAll(e);a.onsuccess=()=>n(a.result||[]),a.onerror=s=>o(s.target.error)})}async function ue(e){const t=await D();return new Promise((n,o)=>{const a=t.transaction("savedCircuits","readwrite").objectStore("savedCircuits").put(e);a.onsuccess=()=>n(),a.onerror=s=>o(s.target.error)})}async function Le(e){const t=await D();return new Promise((n,o)=>{const a=t.transaction("savedCircuits","readwrite").objectStore("savedCircuits").delete(e);a.onsuccess=()=>n(),a.onerror=s=>o(s.target.error)})}async function Ge(){return new Promise(async(e,t)=>{try{const o=(await D()).transaction(["poiUserData","savedCircuits","appState","modifications"],"readwrite"),r=["poiUserData","savedCircuits","appState","modifications"];let a=0;const s=()=>{a++,a===r.length&&e()};r.forEach(l=>{const d=o.objectStore(l).clear();d.onsuccess=s,d.onerror=u=>{console.error(`Erreur lors du vidage de ${l}`,u.target.error),s()}}),o.onerror=l=>{t(l.target.error)}}catch(n){t(n)}})}const Se="3.0.0-mobile",U=15,i={isMobile:!1,currentMapId:null,userData:{},myCircuits:[],geojsonLayer:null,loadedFeatures:[],currentFeatureId:null,currentCircuitIndex:null,isSelectionModeActive:!1,currentCircuit:[],hiddenPoiIds:JSON.parse(localStorage.getItem("djerba_hidden_pois"))||[],activeCircuitId:null,circuitIdToImportFor:null,orthodromicPolyline:null,realTrackPolyline:null,activeFilters:{mosquees:!1,vus:!1,planifies:!1,zone:null}};function pe(e,t,n){const o=new Blob([t],{type:n}),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=e.replace(/[\\/:"*?<>|]/g,"-"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(r.href)}function be(e,t,n,o){let r=e+t/60+n/3600;return(o==="S"||o==="W")&&(r=r*-1),r}function Ve(e){return new Promise((t,n)=>{EXIF.getData(e,function(){const o=EXIF.getTag(this,"GPSLatitude"),r=EXIF.getTag(this,"GPSLatitudeRef"),a=EXIF.getTag(this,"GPSLongitude"),s=EXIF.getTag(this,"GPSLongitudeRef");if(o&&a&&r&&s){const l=be(o[0],o[1],o[2],r),d=be(a[0],a[1],a[2],s);t({lat:l,lng:d})}else n("Pas de donn√©es GPS trouv√©es dans cette photo.")})})}function we(e,t,n,o){const a=e*Math.PI/180,s=n*Math.PI/180,l=(n-e)*Math.PI/180,d=(o-t)*Math.PI/180,u=Math.sin(l/2)*Math.sin(l/2)+Math.cos(a)*Math.cos(s)*Math.sin(d/2)*Math.sin(d/2);return 6371e3*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))}function ze(e,t=1024,n=.7){return new Promise((o,r)=>{const a=new FileReader;a.readAsDataURL(e),a.onload=s=>{const l=new Image;l.src=s.target.result,l.onload=()=>{const d=document.createElement("canvas");let u=l.width,p=l.height;u>t&&(p=Math.round(p*(t/u)),u=t),d.width=u,d.height=p,d.getContext("2d").drawImage(l,0,0,u,p),o(d.toDataURL("image/jpeg",n))},l.onerror=d=>r(d)},a.onerror=s=>r(s)})}async function Me(){await D();const e=indexedDB.open("HistoryWalkDB");return new Promise((t,n)=>{e.onsuccess=o=>t(o.target.result),e.onerror=o=>n(o.target.error)})}async function ne(e,t,n,o,r){let a;try{a=await Me();const l=a.transaction("modifications","readwrite").objectStore("modifications"),d=i.loadedFeatures.find(m=>m.properties.HW_ID===e),u=d?d.properties.userData?.custom_title||d.properties["Nom du site FR"]:"N/A",p={timestamp:new Date().toISOString(),poiId:e,poiName:u||"N/A",action:t,field:n||"N/A",oldValue:o!=null?JSON.stringify(o):JSON.stringify(""),newValue:r!=null?JSON.stringify(r):JSON.stringify("")};l.add(p)}catch(s){console.error("Impossible d'enregistrer la modification dans le journal:",s)}finally{a&&a.close()}}async function Ue(){let e;try{e=await Me();const n=e.transaction("modifications","readonly").objectStore("modifications"),o=await new Promise((u,p)=>{const m=n.getAll();m.onsuccess=()=>u(m.result),m.onerror=g=>p(g.target.error)});if(o.length===0){h("Le journal des modifications est vide.","info");return}const a=[["Timestamp","ID_POI","Nom_POI","Action","Champ","Ancienne_Valeur","Nouvelle_Valeur"].join(";")],s=u=>{if(u==null)return"";let p=String(u);return(p.includes(";")||p.includes('"')||p.includes(`
`))&&(p=p.replace(/"/g,'""'),p=`"${p}"`),p};o.forEach(u=>{let p="";try{p=JSON.parse(u.oldValue)}catch{p=u.oldValue}let m="";try{m=JSON.parse(u.newValue)}catch{m=u.newValue}const g=[u.timestamp,s(u.poiId),s(u.poiName),s(u.action),s(u.field),s(p),s(m)];a.push(g.join(";"))});const l="\uFEFF"+a.join(`
`),d=new Date().toISOString().slice(0,10);pe(`HistoryWalk_Log_${i.currentMapId}_${d}.csv`,l,"text/csv;charset=utf-8;")}catch(t){console.error("Erreur lors de l'export du journal:",t),h("Une erreur est survenue lors de l'export du journal.","error")}finally{e&&e.close()}}function f(e){if(!e)return null;if(e.id)return String(e.id);if(e.properties){if(e.properties.HW_ID)return String(e.properties.HW_ID);if(e.properties.id)return String(e.properties.id);if(e.properties.ID)return String(e.properties.ID)}return null}function C(e){return!e||!e.properties?"Sans nom":e.properties.userData?.custom_title||e.properties["Nom du site FR"]||"Sans nom"}async function A(e,t,n){if(!e||!i.currentMapId)return;const o=i.loadedFeatures.find(a=>f(a)===e);if(!o)return;i.userData[e]||(i.userData[e]={}),o.properties.userData||(o.properties.userData={});const r=i.userData[e][t];if(r!==n){i.userData[e][t]=n,o.properties.userData[t]=n;try{await de(i.currentMapId,e,{[t]:n}),await ne(e,"Modification",t,r,n)}catch(a){console.error(`Erreur de sauvegarde pour le POI ${e}:`,a),alert("Une erreur est survenue lors de la sauvegarde des donn√©es.")}}}function x(){if(!i.geojsonLayer||(i.geojsonLayer.clearLayers(),!i.loadedFeatures||i.loadedFeatures.length===0))return;const e=i.loadedFeatures.filter(t=>{const n={...t.properties,...t.properties.userData},o=f(t);if(i.hiddenPoiIds&&i.hiddenPoiIds.includes(o))return!1;if(n.incontournable||i.isSelectionModeActive&&i.currentCircuit.some(a=>f(a)===f(t)))return!0;if(i.activeFilters.zone&&n.Zone!==i.activeFilters.zone||i.activeFilters.mosquees&&n.Cat√©gorie!=="Mosqu√©e"||i.activeFilters.vus&&n.vu)return!1;const r=(n.planifieCounter||0)>0;return!(i.activeFilters.planifies&&r)});if(e.length>0&&L.geoJSON(e,{pointToLayer:(n,o)=>{const r=L.marker(o,{icon:Ot(n.properties.Cat√©gorie)}),a=i.loadedFeatures.indexOf(n);return r.on("click",s=>{if(L.DomEvent.stop(s),i.isSelectionModeActive)Rt(n);else{const l=i.currentCircuit.findIndex(d=>f(d)===f(n));E(a,l!==-1?l:null)}}),r}}).eachLayer(n=>i.geojsonLayer.addLayer(n)),window.lucide&&lucide.createIcons(),i.activeFilters.zone&&i.geojsonLayer.getLayers().length>0){const t=i.geojsonLayer.getBounds();t&&t.isValid&&t.isValid()&&k.flyToBounds(t.pad(.1))}}async function me(e,t){i.currentMapId=t,document.getElementById("app-title").textContent=`History Walk - ${t}`;try{const n=e.features.length,o=e.features.filter(a=>{const s=f(a);return s||console.warn("Lieu ignor√© (HW_ID manquant):",a.properties["Nom du site FR"]||"Sans nom"),s}),r=n-o.length;if(r>0&&console.error(`${r} lieu(x) sur ${n} ont √©t√© ignor√©(s) car leur 'HW_ID' est manquant ou invalide.`),i.userData=await te(t),i.myCircuits=await K(t),o.forEach(a=>{const s=f(a);a.properties.userData=i.userData[s]||{}}),i.loadedFeatures=o,i.geojsonLayer&&i.geojsonLayer.remove(),i.geojsonLayer=L.featureGroup().addTo(k),ee(),x(),await $t(),!i.activeFilters.zone&&i.loadedFeatures.length>0){const a=L.geoJSON(i.loadedFeatures).getBounds();a.isValid()&&k.flyToBounds(a.pad(.1))}}catch(n){console.error("Erreur lors de l'affichage du GeoJSON:",n),alert("Impossible de charger les donn√©es pour cette carte.")}}function De(e){if(!e)return;i.loadedFeatures.push(e);const t=f(e);if(i.userData&&!i.userData[t]&&(i.userData[t]={}),i.geojsonLayer){const o=L.geoJSON(e).getLayers()[0];typeof i.geojsonLayer.addLayer=="function"?i.geojsonLayer.addLayer(o):typeof i.geojsonLayer.addData=="function"&&i.geojsonLayer.addData(e)}}const ke=window.SpeechRecognition||window.webkitSpeechRecognition;let re=null,w={isActive:!1,currentButton:null,currentTargetInput:null,finalTranscript:""};const We=[{key:"point d'exclamation",value:" !"},{key:"point d'interrogation",value:" ?"},{key:"point virgule",value:" ;"},{key:"deux points",value:" :"},{key:"ouvrir la parenth√®se",value:" ("},{key:"fermer la parenth√®se",value:") "},{key:"√† la ligne",value:`
`},{key:"point",value:"."},{key:"virgule",value:","}];function Je(e){let t=` ${e.toLowerCase()} `;for(const n of We){const o=new RegExp(` ${n.key} `,"g");t=t.replace(o,`${n.value} `)}return t.trim().replace(/((^|\.\s*|\n\s*)[a-z])/g,n=>n.toUpperCase())}function Ce(e,t){e&&(e.classList.toggle("recording",t),e.innerHTML=t?'<i data-lucide="mic-off"></i>':'<i data-lucide="mic"></i>',lucide.createIcons())}function Xe(){if(!ke)return console.warn("La reconnaissance vocale n'est pas support√©e par ce navigateur."),null;const e=new ke;return e.continuous=!0,e.interimResults=!0,e.lang="fr-FR",e.onstart=()=>{w.isActive=!0,w.finalTranscript=w.currentTargetInput.value?w.currentTargetInput.value+" ":"",Ce(w.currentButton,!0)},e.onend=()=>{w.isActive=!1,w.currentTargetInput&&w.currentTargetInput.value&&(w.currentTargetInput.value=Je(w.currentTargetInput.value)),Ce(w.currentButton,!1),w.currentButton=null,w.currentTargetInput=null},e.onresult=t=>{if(!w.currentTargetInput)return;let n="";for(let o=t.resultIndex;o<t.results.length;++o)t.results[o].isFinal?w.finalTranscript+=t.results[o][0].transcript:n+=t.results[o][0].transcript;w.currentTargetInput.value=w.finalTranscript+n},e.onerror=t=>{console.error("Erreur de reconnaissance vocale:",t.error),t.error==="no-speech"||t.error==="audio-capture"?h("Le micro s'est arr√™t√© (inactivit√©/erreur).","warning"):t.error!=="aborted"&&h("Erreur de reconnaissance vocale.","error")},e}re=Xe();function $e(){re&&w.isActive&&re.stop()}function Pe(){return w.isActive}function Ze(e,t){if(!window.speechSynthesis){h("La synth√®se vocale n'est pas support√©e par votre navigateur.","warning");return}const n=()=>{t&&(t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>')};if(window.speechSynthesis.speaking){window.speechSynthesis.cancel(),n();return}if(!e||e.trim()===""){h("Le champ est vide.","info");return}const o=new SpeechSynthesisUtterance(e);o.lang="fr-FR",o.onstart=()=>{t&&(t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>')},o.onend=()=>{n()},o.onerror=()=>{n()},window.speechSynthesis.speak(o)}function b(e){return e==null?"":e.toString().replace(/[<>&'"]/g,t=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"})[t])}function Ke(e,t,n,o){const r=e.map(l=>`<wpt lat="${l.geometry.coordinates[1]}" lon="${l.geometry.coordinates[0]}"><name>${b(C(l))}</name><desc>${b(l.properties.userData?.Description_courte||l.properties.Desc_wpt||"")}</desc></wpt>`).join(""),a=e.map(l=>`<trkpt lat="${l.geometry.coordinates[1]}" lon="${l.geometry.coordinates[0]}"></trkpt>`).join(`
      `),s=`<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="History Walk ${Se}" xmlns="http://www.topografix.com/GPX/1/1"><metadata><name>${b(n)}</name><desc>Circuit g√©n√©r√© par History Walk.</desc></metadata>${r}<trk><name>${b(n)}</name><desc><![CDATA[${o?`${o}
`:""}[HW-ID:${t}]]]></desc><trkseg>${a}</trkseg></trk></gpx>`;pe(`${n}.gpx`,s,"application/gpx+xml")}async function he(e){if(e)try{const t=await te(e),n=await K(e),o={};i.loadedFeatures.forEach(a=>{o[f(a)]=0}),n.forEach(a=>{[...new Set(a.poiIds)].forEach(s=>{o.hasOwnProperty(s)&&o[s]++})});const r=[];for(const[a,s]of Object.entries(o))(t[a]&&t[a].planifieCounter||0)!==s&&r.push({poiId:a,data:{planifieCounter:s}});r.length>0&&await _e(e,r),i.userData=await te(e),i.loadedFeatures.forEach(a=>{const s=f(a);i.userData[s]&&(a.properties.userData={...a.properties.userData,...i.userData[s]})})}catch(t){console.error("Erreur lors du recalcul des compteurs:",t)}}async function Te(){if(i.currentCircuit.length===0)return;const e=fe(),t=await O(`circuitDraft_${i.currentMapId}`);let n=t&&t.description?t.description:"";const o=t&&t.transport?t.transport:{};n.includes("History Walk")||(n+=`

(Cr√©√© par History Walk)`);const a=i.currentCircuit.map(f);let s;if(i.activeCircuitId){const l=i.myCircuits.findIndex(d=>d.id===i.activeCircuitId);l>-1&&(i.myCircuits[l].name=e,i.myCircuits[l].description=n,i.myCircuits[l].poiIds=a,i.myCircuits[l].transport=o,s=i.myCircuits[l])}if(!s){const l=`HW-${Date.now()}`;s={id:l,mapId:i.currentMapId,name:e,description:n,poiIds:a,realTrack:null,transport:o},i.myCircuits.push(s),i.activeCircuitId=l}try{await ue(s),await he(i.currentMapId),x(),Ke(i.currentCircuit,s.id,s.name,s.description),h(`Circuit "${s.name}" sauvegard√© et export√© !`,"success")}catch(l){console.error("Erreur lors de la sauvegarde du circuit :",l),h("Erreur lors de la sauvegarde du circuit.","error")}}const Qe=Object.freeze(Object.defineProperty({__proto__:null,escapeXml:b,recalculatePlannedCountersForMap:he,saveAndExportCircuit:Te},Symbol.toStringTag,{value:"Module"})),Ye="modulepreload",et=function(e){return"/"+e},Ie={},tt=function(t,n,o){let r=Promise.resolve();if(n&&n.length>0){let u=function(p){return Promise.all(p.map(m=>Promise.resolve(m).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};var s=u;document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),d=l?.nonce||l?.getAttribute("nonce");r=u(n.map(p=>{if(p=et(p),p in Ie)return;Ie[p]=!0;const m=p.endsWith(".css"),g=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${g}`))return;const y=document.createElement("link");if(y.rel=m?"stylesheet":Ye,m||(y.as="script"),y.crossOrigin="",y.href=p,d&&y.setAttribute("nonce",d),document.head.appendChild(y),m)return new Promise((S,$)=>{y.addEventListener("load",S),y.addEventListener("error",()=>$(new Error(`Unable to preload CSS for ${p}`)))})}))}function a(l){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=l,window.dispatchEvent(d),!d.defaultPrevented)throw l}return r.then(l=>{for(const d of l||[])d.status==="rejected"&&a(d.reason);return t().catch(a)})};let B=null,Be=null;const nt=["Mosqu√©e","Site historique","Curiosit√©","H√¥tel","Restaurant","Caf√©","Taxi","Commerce"];function M(){return window.innerWidth<=768}async function it(){const e="Djerba.geojson";c.loaderOverlay.style.display="flex";try{const t=await fetch(e);if(!t.ok)throw new Error("Erreur r√©seau");const n=await t.json(),o="Djerba";await I("lastMapId",o),await I("lastGeoJSON",n),h(`Destination par d√©faut "${o}" charg√©e.`,"success"),setTimeout(()=>location.reload(),1500)}catch{h("Fichier de destination par d√©faut introuvable.","error"),c.loaderOverlay.style.display="none",ot()}}async function rt(){document.querySelector(".topbar").style.display="none",document.getElementById("map").style.display="none",c.mobileContainer.style.display="flex";const e=await O("lastMapId"),t=await O("lastGeoJSON");e&&t?(i.currentMapId=e,i.loadedFeatures=t.features,i.myCircuits=await K(e),Fe("circuits"),at(),dt()):await it(),lucide.createIcons()}function ot(){c.mobileNav.style.display="none",c.mobileMainContainer.innerHTML=`
        <div class="welcome-container">
            <h1>Bienvenue sur History Walk</h1>
            <p>Pour commencer, veuillez charger un fichier de destination GeoJSON.</p>
            <button id="welcome-load-btn" class="btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
                Charger une Destination
            </button>
        </div>
    `,document.getElementById("welcome-load-btn").addEventListener("click",()=>{c.destinationLoader.click()}),c.destinationLoader.addEventListener("change",oe)}async function oe(e){const t=e.target.files[0];if(!t)return;c.loaderOverlay.style.display="flex";const n=new FileReader;n.onload=async o=>{try{const r=JSON.parse(o.target.result);if(!r.features)throw new Error("Fichier invalide");const a=t.name.replace(/\.geojson$|\.json$/i,"");await I("lastMapId",a),await I("lastGeoJSON",r),h(`Destination "${a}" charg√©e.`,"success"),setTimeout(()=>location.reload(),1500)}catch{h("Fichier de destination invalide.","error"),c.loaderOverlay.style.display="none"}},n.readAsText(t)}function at(){c.mobileNav.addEventListener("click",e=>{const t=e.target.closest(".mobile-nav-btn");if(t){if(t.dataset.view==="add-poi"){st();return}c.mobileNav.querySelectorAll(".mobile-nav-btn").forEach(n=>n.classList.remove("active")),t.classList.add("active"),Fe(t.dataset.view)}})}function Fe(e){switch(c.mobileMainContainer.style.display="block",c.mobileMainContainer.innerHTML="",e!=="circuits"&&(B=null),e){case"circuits":H();break;case"search":gt();break;case"actions":vt();break;default:H()}lucide.createIcons()}function st(){c.loaderOverlay.style.display="flex",navigator.geolocation.getCurrentPosition(e=>{c.loaderOverlay.style.display="none";const{latitude:t,longitude:n,accuracy:o}=e.coords;Be=[n,t],ct(t,n,o)},e=>{c.loaderOverlay.style.display="none",console.error(e),h("Impossible d'obtenir la position GPS.","error")},{enableHighAccuracy:!0,timeout:1e4})}function ct(e,t,n){const o=document.getElementById("add-poi-modal");if(!o){console.error("Erreur: Modale d'ajout introuvable dans le HTML");return}const r=document.getElementById("new-poi-coords"),a=document.getElementById("new-poi-name"),s=document.getElementById("new-poi-category");a.value="",r.textContent=`${e.toFixed(5)}, ${t.toFixed(5)} (Pr√©cision: ${Math.round(n)}m)`,lt(s),o.style.display="flex",a.focus()}function lt(e){e.innerHTML="";const t=new Set(i.loadedFeatures.map(o=>o.properties.Cat√©gorie).filter(Boolean)),n=new Set([...nt,...t]);Array.from(n).sort().forEach(o=>{const r=document.createElement("option");r.value=o,r.textContent=o,o==="Mosqu√©e"&&i.currentMapId?.includes("Djerba")&&(r.selected=!0),e.appendChild(r)})}function dt(){const e=document.getElementById("add-poi-modal");if(!e)return;const t=document.getElementById("close-add-poi-modal"),n=document.getElementById("btn-confirm-add-poi"),o=()=>{e.style.display="none"};t.addEventListener("click",o),n.addEventListener("click",async()=>{const r=document.getElementById("new-poi-name").value.trim(),a=document.getElementById("new-poi-category").value;if(!r){h("Veuillez donner un nom au lieu.","warning");return}const s=`HW-NEW-${Date.now()}`;De({type:"Feature",geometry:{type:"Point",coordinates:Be},properties:{"Nom du site FR":r,Cat√©gorie:a,Zone:"A d√©finir",Description:"Ajout√© depuis mobile",HW_ID:s}});try{await I("lastGeoJSON",{type:"FeatureCollection",features:i.loadedFeatures}),await ne(s,"Cr√©ation","All",null,"Nouveau lieu mobile"),h(`Lieu "${r}" ajout√© !`,"success"),o();const d=document.querySelector(".mobile-nav-btn.active");d&&d.dataset.view;const u=i.loadedFeatures.length-1;E(u)}catch(d){console.error(d),h("Erreur lors de la sauvegarde.","error")}})}function ie(){const e=!!B,t=e?B.name:"";c.mobileMainContainer.innerHTML=`
        <div class="mobile-view-header">
            <button id="gen-back-btn" class="header-btn"><i data-lucide="arrow-left"></i></button>
            <h1 class="header-title-mobile">G√©n√©rateur Automatique</h1>
        </div>
        <div class="generator-container">
            <div class="generator-card">
                <div class="generator-label">1. Point de d√©part</div>
                <button class="action-btn-large btn-brand" id="btn-use-gps">
                    <i data-lucide="crosshair"></i> Ma Position GPS
                </button>
                <div style="text-align: center; font-size: 13px; color: var(--ink-soft);">- OU -</div>
                <button class="action-btn-large" id="btn-select-start-poi" style="background: var(--surface-muted); color: var(--ink);">
                    <i data-lucide="map-pin"></i> Choisir un POI
                </button>
                
                <div id="selected-start-info" style="text-align: center; color: var(--ok); font-weight: bold; display: ${e?"block":"none"};">
                    üìç ${b(t)}
                </div>
            </div>

            <div class="generator-card">
                <div class="generator-label">2. Rayon de recherche</div>
                <div class="radius-display"><span id="radius-val">3</span> km</div>
                <input type="range" id="radius-slider" min="1" max="20" value="3" step="0.5">
            </div>

            <button id="btn-launch-search" class="action-btn-large btn-brand" ${e?"":"disabled"}>
                Lancer la recherche
            </button>
        </div>
    `,lucide.createIcons(),document.getElementById("gen-back-btn").addEventListener("click",()=>{B=null,H()});const n=document.getElementById("radius-slider"),o=document.getElementById("radius-val");n.addEventListener("input",r=>{o.textContent=r.target.value}),document.getElementById("btn-use-gps").addEventListener("click",()=>{if(!navigator.geolocation)return h("GPS non support√©","error");h("Localisation en cours...","info"),navigator.geolocation.getCurrentPosition(r=>{B={lat:r.coords.latitude,lng:r.coords.longitude,name:"Ma Position"};const a=document.getElementById("selected-start-info");a.textContent="üìç Ma Position GPS",a.style.display="block",document.getElementById("btn-launch-search").disabled=!1,h("Position GPS acquise !","success")},r=>{h("Erreur GPS : "+r.message,"error")},{enableHighAccuracy:!0})}),document.getElementById("btn-select-start-poi").addEventListener("click",()=>{ut(r=>{const a=r.geometry.coordinates;B={lat:a[1],lng:a[0],name:C(r)},ie()})}),document.getElementById("btn-launch-search").addEventListener("click",()=>{if(!B)return;const r=parseFloat(n.value);pt(B,r)})}function ut(e){c.mobileMainContainer.innerHTML=`
        <div class="mobile-view-header">
            <button id="search-back-btn" class="header-btn"><i data-lucide="arrow-left"></i></button>
            <div class="search-container mobile-search" style="flex-grow:1; margin-left:10px;">
                <input type="search" id="gen-search-input" placeholder="Chercher un point de d√©part...">
            </div>
        </div>
        <div id="gen-search-results" class="mobile-list"></div>
    `,lucide.createIcons(),document.getElementById("search-back-btn").addEventListener("click",ie);const t=document.getElementById("gen-search-input"),n=document.getElementById("gen-search-results");t.addEventListener("input",()=>{const o=t.value.toLowerCase();if(o.length<2)return;const r=i.loadedFeatures.filter(a=>C(a).toLowerCase().includes(o));n.innerHTML=r.map(a=>`
            <button class="mobile-list-item" data-id="${f(a)}">
                <span>${b(C(a))}</span>
            </button>
        `).join(""),n.querySelectorAll("button").forEach(a=>{a.addEventListener("click",()=>{const s=i.loadedFeatures.find(l=>f(l)===a.dataset.id);e(s)})})}),t.focus()}function pt(e,t){if(typeof L>"u"){h("Erreur: Carte non initialis√©e","error");return}const n=i.loadedFeatures.map(o=>{const[r,a]=o.geometry.coordinates,s=L.latLng(e.lat,e.lng).distanceTo(L.latLng(a,r))/1e3;return{feature:o,dist:s}}).filter(o=>o.dist<=t&&o.dist>0).sort((o,r)=>o.dist-r.dist);mt(n,e)}function mt(e,t){c.mobileMainContainer.innerHTML=`
        <div class="mobile-view-header">
            <button id="res-back-btn" class="header-btn"><i data-lucide="arrow-left"></i></button>
            <h1 class="header-title-mobile">${e.length} lieux trouv√©s</h1>
        </div>
        <div class="mobile-list" style="padding: 10px;">
            <div style="margin-bottom: 10px; color: var(--ink-soft); font-size: 14px;">
                Autour de : <strong>${b(t.name)}</strong>
            </div>
            <div class="poi-selection-list">
                ${e.map(n=>`
                    <label class="poi-checkbox-item checked">
                        <input type="checkbox" checked value="${f(n.feature)}">
                        <div class="poi-info">
                            <strong>${b(C(n.feature))}</strong>
                            <span>${n.feature.properties.Zone||"Inconnu"} ‚Ä¢ ${n.dist.toFixed(2)} km</span>
                        </div>
                    </label>
                `).join("")}
            </div>
            <div style="height: 80px;"></div> </div>
        <div style="position: fixed; bottom: 0; left: 0; width: 100%; padding: 16px; background: var(--surface); box-shadow: 0 -4px 10px rgba(0,0,0,0.1); box-sizing: border-box;">
            <button id="btn-create-generated-circuit" class="action-btn-large btn-brand">
                Cr√©er le Circuit
            </button>
        </div>
    `,lucide.createIcons(),document.getElementById("res-back-btn").addEventListener("click",ie),document.querySelectorAll(".poi-checkbox-item input").forEach(n=>{n.addEventListener("change",o=>{o.target.closest(".poi-checkbox-item").classList.toggle("checked",o.target.checked)})}),document.getElementById("btn-create-generated-circuit").addEventListener("click",()=>{const n=Array.from(document.querySelectorAll(".poi-checkbox-item input:checked")).map(o=>o.value);if(n.length===0)return h("Aucun lieu s√©lectionn√©.","warning");ht(n)})}async function ht(e){i.currentCircuit=[],i.activeCircuitId=null,e.forEach(t=>{const n=i.loadedFeatures.find(o=>f(o)===t);n&&i.currentCircuit.push(n)}),await J(),h("Circuit g√©n√©r√© avec succ√®s !","success"),B=null,ve(null)}function H(){c.mobileMainContainer.innerHTML=`
        <div class="mobile-view-header">
            <h1 class="header-title-mobile">${i.currentMapId||"Circuits"}</h1>
        </div>
        <div class="mobile-list">
            ${i.myCircuits.length>0?i.myCircuits.map(t=>`
                <button class="mobile-list-item" data-circuit-id="${t.id}">
                    <i data-lucide="route"></i>
                    <span>${b(t.name)}</span>
                    <i data-lucide="chevron-right"></i>
                </button>
            `).join(""):'<p class="empty-list-info">Aucun circuit.</p>'}
        </div>
    `,c.mobileMainContainer.querySelectorAll(".mobile-list-item").forEach(t=>{t.addEventListener("click",()=>{ve(t.dataset.circuitId)})}),document.querySelectorAll(".mobile-nav-btn").forEach(t=>t.classList.remove("active"));const e=document.querySelector('[data-view="circuits"]');e&&e.classList.add("active"),lucide.createIcons()}window.openGeneratorModal=()=>ie();function ve(e){let t="Nouveau Circuit (Brouillon)",n=!1;if(e){const r=i.myCircuits.find(a=>a.id===e);if(!r)return;i.activeCircuitId=e,i.currentCircuit=r.poiIds.map(a=>i.loadedFeatures.find(s=>f(s)===a)).filter(Boolean),t=r.name}else n=!0,i.activeCircuitId=null;let o=Re(i.currentCircuit);c.mobileMainContainer.innerHTML=`
        <div class="mobile-view-header">
            <button id="mobile-back-btn" class="header-btn"><i data-lucide="arrow-left"></i></button>
            <div style="flex-grow:1; text-align:center;">
                <h1 class="header-title-mobile" style="font-size: 18px;">${b(t)}</h1>
                ${n?'<span style="font-size:12px; color:var(--warn);">Non sauvegard√©</span>':""}
            </div>
            ${n?'<button id="mobile-save-circuit" class="header-btn" title="Sauvegarder" style="color:var(--ok);"><i data-lucide="save"></i></button>':""}
        </div>
        <div class="circuit-info-bar">
            <span><i data-lucide="map-pins"></i> ${i.currentCircuit.length} POI</span> 
            <span><i data-lucide="bird"></i> ${(o/1e3).toFixed(1)} km</span>
        </div>
        <div class="mobile-list"> 
            ${i.currentCircuit.length>0?i.currentCircuit.map((r,a)=>{const s=Nt(r);return`
                <button class="mobile-list-item" data-poi-id="${f(r)}" data-circuit-index="${a}">
                    <div class="num">${a+1}</div>
                    <div class="poi-list-icon">${s}</div> 
                    <span>${b(C(r))}</span>
                    <i data-lucide="chevron-right"></i>
                </button>
                `}).join(""):'<p class="empty-list-info">Ce circuit est vide.</p>'}
        </div>
    `,document.getElementById("mobile-back-btn").addEventListener("click",H),n&&document.getElementById("mobile-save-circuit").addEventListener("click",async()=>{const{saveAndExportCircuit:r}=await tt(async()=>{const{saveAndExportCircuit:a}=await Promise.resolve().then(()=>Qe);return{saveAndExportCircuit:a}},void 0);await r(),H()}),c.mobileMainContainer.querySelectorAll(".mobile-list-item").forEach(r=>{r.addEventListener("click",()=>{const a=i.loadedFeatures.find(l=>f(l)===r.dataset.poiId),s=i.loadedFeatures.indexOf(a);E(s,parseInt(r.dataset.circuitIndex,10))})}),lucide.createIcons()}function vt(){c.mobileMainContainer.innerHTML=`
        <div class="mobile-view-header">
            <h1>Actions</h1>
        </div>
        <div class="mobile-list actions-list">
             <button class="mobile-list-item" id="mobile-btn-load-destination">
                <i data-lucide="map"></i>
                <span>Charger une autre Destination</span>
            </button>
            <button class="mobile-list-item" id="mobile-btn-change-theme">
                <i data-lucide="palette"></i>
                <span>Changer le th√®me</span>
            </button>
            <button class="mobile-list-item" id="mobile-btn-save-data">
                <i data-lucide="save"></i>
                <span>Sauvegarder mes donn√©es</span>
            </button>
            <button class="mobile-list-item" id="mobile-btn-restore-data">
                <i data-lucide="folder-down"></i>
                <span>Restaurer mes donn√©es</span>
            </button>
            <button class="mobile-list-item" id="mobile-btn-export-log">
                <i data-lucide="history"></i>
                <span>Exporter le journal</span>
            </button>
            <button class="mobile-list-item" id="mobile-btn-clear-db" style="color: var(--danger);">
                <i data-lucide="trash-2"></i>
                <span>Vider les donn√©es locales</span>
            </button>
        </div>
    `,document.getElementById("mobile-btn-load-destination").addEventListener("click",()=>c.destinationLoader.click()),document.getElementById("mobile-btn-save-data").addEventListener("click",He),document.getElementById("mobile-btn-restore-data").addEventListener("click",()=>c.restoreLoader.click()),document.getElementById("mobile-btn-export-log").addEventListener("click",Ue),document.getElementById("mobile-btn-clear-db").addEventListener("click",ft),document.getElementById("mobile-btn-change-theme").addEventListener("click",()=>{const e=["maritime","desert","oasis","night"],t=document.documentElement.getAttribute("data-theme")||"maritime",o=(e.indexOf(t)+1)%e.length,r=e[o];document.documentElement.setAttribute("data-theme",r),I("currentTheme",r)}),c.restoreLoader.removeEventListener("change",ce),c.restoreLoader.addEventListener("change",ce),c.destinationLoader.removeEventListener("change",oe),c.destinationLoader.addEventListener("change",oe),lucide.createIcons()}async function ft(){if(confirm("ATTENTION : Ceci effacera TOUTES les donn√©es locales (POIs modifi√©s, circuits, journal). Voulez-vous continuer ?"))try{await Ge(),h("Donn√©es locales effac√©es. L'application va red√©marrer.","success"),setTimeout(()=>location.reload(),2e3)}catch(e){console.error("Erreur lors de la suppression des donn√©es:",e),h("Erreur lors de la suppression des donn√©es.","error")}}function gt(){c.mobileMainContainer.innerHTML=`
        <div class="mobile-view-header">
            <div class="search-container mobile-search">
                <i data-lucide="search" class="search-icon"></i>
                <input type="search" id="mobile-search-input" placeholder="Rechercher un lieu...">
            </div>
        </div>
        <div id="mobile-search-results" class="mobile-list">
             <p class="empty-list-info">Commencez √† taper pour rechercher.</p>
        </div>
    `;const e=document.getElementById("mobile-search-input"),t=document.getElementById("mobile-search-results");e.addEventListener("input",()=>{const n=e.value.toLowerCase().trim();if(n.length<2){t.innerHTML='<p class="empty-list-info">Commencez √† taper pour rechercher.</p>';return}const o=i.loadedFeatures.filter(r=>C(r).toLowerCase().includes(n));if(o.length===0){t.innerHTML='<p class="empty-list-info">Aucun r√©sultat trouv√©.</p>';return}t.innerHTML=o.map(r=>`
            <button class="mobile-list-item" data-poi-id="${f(r)}">
                <span>${b(C(r))}</span>
                <i data-lucide="chevron-right"></i>
            </button>
        `).join(""),t.querySelectorAll(".mobile-list-item").forEach(r=>{r.addEventListener("click",()=>{const a=i.loadedFeatures.find(l=>f(l)===r.dataset.poiId),s=i.loadedFeatures.indexOf(a);E(s,null)})}),lucide.createIcons()}),lucide.createIcons(),e.focus()}function yt(e){if(!navigator.geolocation){h("La g√©olocalisation n'est pas support√©e.","error");return}h("Mise √† jour de la position...","info",3e3),c.loaderOverlay.style.display="flex",navigator.geolocation.getCurrentPosition(async t=>{const{latitude:n,longitude:o,accuracy:r}=t.coords,a=i.loadedFeatures.find(s=>f(s)===e);if(a){const s=[...a.geometry.coordinates];a.geometry.coordinates=[o,n],a.properties&&(a.properties.Accuracy=r);try{await I("lastGeoJSON",{type:"FeatureCollection",features:i.loadedFeatures}),await ne(e,"D√©placement","coordinates",s,[o,n]),c.loaderOverlay.style.display="none",h("Position mise √† jour !","success"),E(i.currentFeatureId,i.currentCircuitIndex)}catch{c.loaderOverlay.style.display="none",h("Erreur sauvegarde.","error")}}else c.loaderOverlay.style.display="none",h("Erreur : POI non trouv√©.","error")},t=>{c.loaderOverlay.style.display="none",h("Impossible d'obtenir la position GPS.","error")},{enableHighAccuracy:!0,timeout:15e3})}const c={};let ae={fieldId:null,poiId:null,callback:null},N=[],j=0;const v={pen:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="m15 5 3 3"/></svg>',check:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>',x:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',chevronLeft:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>',chevronRight:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>',arrowLeftToLine:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="m12 19-7-7 7-7"/><path d="M3 3v18"/></svg>',volume:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>',imagePlus:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" x2="22" y1="5" y2="5"/><line x1="19" x2="19" y1="2" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>',locate:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="2" x2="5" y1="12" y2="12"/><line x1="19" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="5"/><line x1="12" x2="12" y1="19" y2="22"/><circle cx="12" cy="12" r="7"/><circle cx="12" cy="12" r="3"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',minus:'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>',plus:'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',ticket:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>',upload:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>',play:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"/></svg>',trash:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',googleMaps:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>'};function bt(){["geojson-loader","search-input","search-results","btn-mode-selection","right-sidebar","sidebar-tabs","details-panel","circuit-panel","circuit-steps-list","circuit-title-text","circuit-title-input","circuit-description","edit-circuit-title-button","circuit-poi-count","circuit-distance","circuits-modal","close-circuits-modal","circuits-list-container","gpx-importer","btn-my-circuits","btn-export-gpx","btn-import-gpx","loader-overlay","btn-save-data","btn-restore-data","restore-loader","btn-open-geojson","mobile-container","mobile-main-container","mobile-nav","fullscreen-editor","editor-title","editor-cancel-btn","editor-save-btn","editor-textarea","destination-loader","photo-viewer","viewer-img","viewer-next","viewer-prev"].forEach(n=>{const o=n.replace(/-(\w)/g,(r,a)=>a.toUpperCase());c[o]=document.getElementById(n)}),c.tabButtons=document.querySelectorAll(".tab-button"),c.sidebarPanels=document.querySelectorAll(".sidebar-panel"),c.editorCancelBtn.addEventListener("click",()=>c.fullscreenEditor.style.display="none"),c.editorSaveBtn.addEventListener("click",()=>{ae.callback&&ae.callback(c.editorTextarea.value),c.fullscreenEditor.style.display="none"});const t=document.querySelector(".close-viewer");t&&(t.addEventListener("click",()=>{c.photoViewer.style.display="none"}),c.photoViewer.addEventListener("click",n=>{n.target===c.photoViewer&&(c.photoViewer.style.display="none")})),c.viewerNext&&c.viewerNext.addEventListener("click",n=>{n.stopPropagation(),Q(1)}),c.viewerPrev&&c.viewerPrev.addEventListener("click",n=>{n.stopPropagation(),Q(-1)}),document.addEventListener("keydown",n=>{c.photoViewer&&c.photoViewer.style.display==="block"&&(n.key==="ArrowRight"&&Q(1),n.key==="ArrowLeft"&&Q(-1),n.key==="Escape"&&(c.photoViewer.style.display="none"))})}function Q(e){N.length<=1||(j+=e,j>=N.length&&(j=0),j<0&&(j=N.length-1),c.viewerImg.src=N[j])}function wt(e,t,n,o,r){c.editorTitle.textContent=`√âditer: ${e}`,c.editorTextarea.value=t,ae={fieldId:n,poiId:o,callback:r},c.fullscreenEditor.style.display="flex",c.editorTextarea.focus()}function kt(e,t){const n=document.querySelector(`.editable-field[data-field-id="${e}"]`);if(!n)return;const o=n.querySelector(".editable-text, .editable-content"),r=n.querySelector(".editable-input"),a=n.querySelector(".edit-btn"),s=n.querySelector(".save-btn"),l=n.querySelector(".cancel-btn"),d=n.querySelector(".speak-btn"),u=async p=>{await A(t,e==="title"?"custom_title":e==="short_desc"?"Description_courte":e,p.trim()),E(i.currentFeatureId,i.currentCircuitIndex)};a&&a.addEventListener("click",()=>{const p=i.loadedFeatures.find(y=>f(y)===t),m=p.properties.userData||{};let g="";e==="title"?g=m.custom_title||p.properties["Nom du site FR"]||"":e==="short_desc"?g=m.Description_courte||p.properties.Desc_wpt||"":g=m[e]||p.properties[e]||p.properties[e.charAt(0).toUpperCase()+e.slice(1)]||"",M()&&(e==="description"||e==="notes")?wt(e,g,e,t,u):(r.value=g,o&&(o.style.display="none"),r.style.display=r.tagName==="TEXTAREA"?"flex":"block",a.style.display="none",d&&(d.style.display="none"),s&&(s.style.display="inline-flex"),l&&(l.style.display="inline-flex"),r.focus())}),l&&l.addEventListener("click",()=>{o&&(o.style.display=r.tagName==="TEXTAREA"||e==="title"?"":"block"),e==="title"&&o&&(o.style.display="block"),r.style.display="none",a.style.display="inline-flex",d&&(d.style.display="inline-flex"),s&&(s.style.display="none"),l&&(l.style.display="none")}),s&&s.addEventListener("click",()=>{u(r.value)}),d&&d.addEventListener("click",()=>{const p=o.textContent;Ze(p,d)})}function xe(e){const t=e.Source;if(!t||typeof t!="string"||t.trim()==="")return"";const n=t.split(`
`)[0].trim();try{const o=n.startsWith("http")?n:`https://${n}`;new URL(o);const r=new URL(o).hostname.replace(/^www\./,"");return`<div class="source-container">Source: <a href="${o}" target="_blank" rel="noopener noreferrer">${r}</a></div>`}catch{return`<div class="source-container">Source: <span>${b(n)}</span></div>`}}function Ct(e){["title","short_desc","description","notes"].forEach(t=>{kt(t,e)})}async function It(e,t=800){return new Promise(n=>{const o=new FileReader;o.readAsDataURL(e),o.onload=r=>{const a=new Image;a.src=r.target.result,a.onload=()=>{const s=document.createElement("canvas");let l=a.width,d=a.height;const u=Math.min(l,d);if(u>t){const m=t/u;l*=m,d*=m}s.width=l,s.height=d,s.getContext("2d").drawImage(a,0,0,l,d),n(s.toDataURL("image/jpeg",.8))}}})}function xt(e){document.getElementById("panel-price").addEventListener("input",r=>A(e,"price",r.target.value)),document.getElementById("panel-chk-vu").addEventListener("change",r=>{A(e,"vu",r.target.checked),i.activeFilters.vus&&!M()&&x()}),document.getElementById("panel-chk-incontournable").addEventListener("change",r=>{A(e,"incontournable",r.target.checked),(i.activeFilters.vus||i.activeFilters.planifies)&&!M()&&x()}),document.getElementById("panel-chk-verified").addEventListener("change",r=>{A(e,"verified",r.target.checked)});const t=document.getElementById("btn-soft-delete");t&&t.addEventListener("click",()=>{typeof window.requestSoftDelete=="function"?window.requestSoftDelete(i.currentFeatureId):(console.error("Fonction requestSoftDelete introuvable !"),alert("Erreur : Fonction non trouv√©e. Avez-vous mis √† jour main.js ?"))});const n=document.getElementById("panel-photo-input"),o=document.querySelector(".photo-placeholder");if(o&&o.addEventListener("click",()=>n.click()),n&&n.addEventListener("change",async r=>{const a=Array.from(r.target.files);if(a.length===0)return;h("Traitement des photos...","info");const d=(i.loadedFeatures.find(m=>f(m)===e).properties.userData||{}).photos||[],u=[];for(const m of a)try{const g=await It(m);u.push(g)}catch(g){console.error("Erreur image",g)}const p=[...d,...u];await A(e,"photos",p),h(`${u.length} photo(s) ajout√©e(s).`,"success"),E(i.currentFeatureId,i.currentCircuitIndex)}),document.querySelectorAll(".photo-item .img-preview").forEach(r=>{r.addEventListener("click",a=>{N=(i.loadedFeatures.find(u=>f(u)===e).properties.userData||{}).photos||[],j=parseInt(a.target.closest(".photo-item").querySelector(".photo-delete-btn").dataset.index,10),c.viewerImg.src=N[j],c.photoViewer.style.display="flex";const d=N.length>1?"block":"none";c.viewerNext&&(c.viewerNext.style.display=d),c.viewerPrev&&(c.viewerPrev.style.display=d)})}),document.querySelectorAll(".photo-delete-btn").forEach(r=>{r.addEventListener("click",async a=>{if(!confirm("Supprimer cette photo ?"))return;const s=parseInt(a.target.closest(".photo-delete-btn").dataset.index,10),u=(i.loadedFeatures.find(p=>f(p)===e).properties.userData.photos||[]).filter((p,m)=>m!==s);await A(e,"photos",u),E(i.currentFeatureId,i.currentCircuitIndex)})}),document.getElementById("time-increment-btn")?.addEventListener("click",()=>Ee(5)),document.getElementById("time-decrement-btn")?.addEventListener("click",()=>Ee(-5)),M()){const r=document.getElementById("mobile-move-poi-btn");r&&r.addEventListener("click",()=>{confirm("Mettre √† jour la position de ce POI avec votre position GPS actuelle ?")&&yt(e)}),document.getElementById("details-prev-btn")?.addEventListener("click",()=>Y(-1)),document.getElementById("details-next-btn")?.addEventListener("click",()=>Y(1)),document.getElementById("details-close-btn")?.addEventListener("click",()=>W(!0))}else document.getElementById("prev-poi-button")?.addEventListener("click",()=>Y(-1)),document.getElementById("next-poi-button")?.addEventListener("click",()=>Y(1)),document.getElementById("close-details-button")?.addEventListener("click",W)}function Et(e,t){const n={...e.properties,...e.properties.userData},o=C(e),r=t!==null;let a="00h00",s=0,l=0;if(n.timeH!==void 0&&n.timeM!==void 0)s=n.timeH,l=n.timeM;else if(n["Temps de visite"]){const T=n["Temps de visite"].split(":");s=parseInt(T[0],10)||0,l=parseInt(T[1],10)||0}a=`${String(s).padStart(2,"0")}h${String(l).padStart(2,"0")}`;const d=n.price!==void 0?n.price:parseFloat(n["Prix d'entr√©e"])||"",u=n.vu?"checked":"",p=n.incontournable?"checked":"",m=n.verified?"checked":"",g=n.photos||[];let y=g.map((T,V)=>`
        <div class="photo-item">
            <img src="${T}" class="img-preview" title="Cliquez pour agrandir">
            <button class="photo-delete-btn" data-index="${V}">${v.trash}</button>
        </div>
    `).join("");const S=`
        <div class="detail-section">
            <h3>D√©tails Pratiques</h3>
            <div class="content structured-input-row">
                <div class="input-group">
                    ${v.clock}
                    <div class="time-editor">
                        <button class="time-adjust-btn" id="time-decrement-btn" title="Diminuer de 5 minutes">${v.minus}</button>
                        <span id="panel-time-display" class="duration-picker-trigger" data-hours="${s}" data-minutes="${l}">${a}</span>
                        <button class="time-adjust-btn" id="time-increment-btn" title="Augmenter de 5 minutes">${v.plus}</button>
                    </div>
                </div>
                <div class="input-group">
                    ${v.ticket}
                    <div class="price-editor fields">
                        <input type="number" id="panel-price" min="0" placeholder="0" value="${d}"><span class="currency">TND</span>
                    </div>
                </div>
            </div>
        </div>`,$=`<button class="action-button" id="open-gmaps-btn" title="Itin√©raire Google Maps">${v.googleMaps}</button>`,G=`
        <div class="panel-header editable-field" data-field-id="title">
            <div class="editable-content">
                <h2 id="panel-title-display">${b(o)}</h2>
                <p class="panel-nom-arabe">${b(n["Nom du site arabe"]||"")}</p>
		<p style="color: red; font-weight: bold; font-size: 12px; margin-top: 5px;"></p>
            </div>
            <input type="text" id="panel-title-input" class="editable-input header-input" style="display: none;">
            <div class="edit-controls">
                ${$}
                <button class="action-button edit-btn" title="Modifier le nom">${v.pen}</button>
                
                <button class="action-button" id="btn-soft-delete" title="Signaler pour suppression" style="color: var(--danger);">
                    ${v.trash}
                </button>
                <button class="action-button save-btn" title="Sauvegarder" style="display: none;">${v.check}</button>
                <button class="action-button cancel-btn" title="Annuler" style="display: none;">${v.x}</button>
            </div>
            <div class="details-nav">
                ${r?`<button class="header-btn" id="prev-poi-button" title="POI Pr√©c√©dent" ${t===0?"disabled":""}>${v.chevronLeft}</button>
                              <button class="header-btn" id="next-poi-button" title="POI Suivant" ${t===i.currentCircuit.length-1?"disabled":""}>${v.chevronRight}</button>`:""}
                <button class="header-btn" id="close-details-button" title="${i.isSelectionModeActive?"Retour au circuit":"Fermer"}">${i.isSelectionModeActive?v.arrowLeftToLine:v.x}</button>
            </div>
        </div>
        <div class="panel-content">
            <div class="detail-section editable-field" data-field-id="short_desc">
                <h3>Description Courte (GPX)
                    <div class="edit-controls section-controls">
                        <button class="action-button edit-btn" title="√âditer">${v.pen}</button>
                        <button class="action-button save-btn" title="Sauvegarder" style="display: none;">${v.check}</button>
                        <button class="action-button cancel-btn" title="Annuler" style="display: none;">${v.x}</button>
                    </div>
                </h3>
                <div class="content">
                    <p id="panel-short-desc-display" class="editable-text short-text">${b(n.Description_courte||n.Desc_wpt||"")}</p>
                    <input type="text" id="panel-short-desc-input" class="editable-input" style="display: none;" placeholder="R√©sum√© pour l'export GPX..." maxlength="250">
                </div>
            </div>
            <div class="detail-section editable-field description-section" data-field-id="description">
                <h3>Description
                    <div class="edit-controls section-controls">
                        <button class="action-button speak-btn" title="Lire la description">${v.volume}</button>
                        <button class="action-button edit-btn" title="√âditer">${v.pen}</button>
                        <button class="action-button save-btn" title="Sauvegarder" style="display: none;">${v.check}</button>
                        <button class="action-button cancel-btn" title="Annuler" style="display: none;">${v.x}</button>
                    </div>
                </h3>
                <div class="content">
                    <div id="panel-description-display" class="description-content editable-text">${(n.description||n.Description||"").replace(/\n/g,"<br>")}</div>
                    <textarea id="panel-description-input" class="editable-input" style="display: none;" spellcheck="true"></textarea>
                    ${xe(n)}
                </div>
            </div>
            ${S}
            <div class="detail-section">
                <h3>Mon Suivi</h3>
                <div class="content checkbox-group">
                  <label class="checkbox-label"><input type="checkbox" id="panel-chk-vu" ${u}> Visit√©</label>
                  <label class="checkbox-label"><input type="checkbox" id="panel-chk-incontournable" ${p}> Incontournable</label>
                  <label class="checkbox-label"><input type="checkbox" id="panel-chk-verified" ${m}> V√©rifi√©</label>
                </div>
            </div>
            <div class="detail-section editable-field notes-section" data-field-id="notes">
                <h3>Notes Personnelles
                     <div class="edit-controls section-controls">
                        <button class="action-button speak-btn" title="Lire les notes">${v.volume}</button>
                        <button class="action-button edit-btn" title="√âditer">${v.pen}</button>
                        <button class="action-button save-btn" title="Sauvegarder" style="display: none;">${v.check}</button>
                        <button class="action-button cancel-btn" title="Annuler" style="display: none;">${v.x}</button>
                    </div>
                </h3>
                <div class="content">
                    <div id="panel-notes-display" class="description-content editable-text">${(n.notes||"").replace(/\n/g,"<br>")}</div>
                    <textarea id="panel-notes-input" class="editable-input" placeholder="Ajoutez vos notes ici..." style="display:none;"></textarea>
                </div>
            </div>
            <div class="detail-section photos-section">
                <h3>Photos (${g.length})</h3>
                <div class="content">
                    <div class="photos-grid-scroller">
                        ${y}
                        <div class="photo-placeholder" title="Ajouter une photo">${v.imagePlus}</div>
                    </div>
                    <input type="file" id="panel-photo-input" accept="image/*" multiple style="display: none;">
                </div>
            </div>
        </div>`,P=`
        <div class="panel-content">
            <div class="detail-section editable-field" data-field-id="title">
                <div class="content">
                    <div class="title-section-line">
                        <div class="title-names editable-content">
                            <h2 class="editable-text">${b(o)}</h2>
                        </div>
                        <div class="title-actions details-header-nav">
                            <button id="details-prev-btn" data-direction="-1" ${!r||t===0?"disabled":""}>${v.chevronLeft}</button>
                            <button id="details-next-btn" data-direction="1" ${!r||t===i.currentCircuit.length-1?"disabled":""}>${v.chevronRight}</button>
                            <button id="details-close-btn">${v.x}</button>
                        </div>
                    </div>
                     <input type="text" class="editable-input" style="display: none;" value="${b(o)}">
                    <div class="title-section-line">
                        <div class="title-names">
                             <p class="panel-nom-arabe editable-text">${b(n["Nom du site arabe"]||"")}</p>
                        </div>
                        <div class="title-actions edit-controls">
                             ${$}
                             <button id="mobile-move-poi-btn" class="action-button" title="Mettre √† jour la position">${v.locate}</button>
                             <button class="action-button edit-btn" title="√âditer">${v.pen}</button>
                             <button class="action-button save-btn" title="Sauvegarder" style="display: none;">${v.check}</button>
                             <button class="action-button cancel-btn" title="Annuler" style="display: none;">${v.x}</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="detail-section editable-field" data-field-id="short_desc">
                <h3>Description Courte (GPX)
                    <div class="edit-controls section-controls">
                        <button class="action-button edit-btn" title="√âditer">${v.pen}</button>
                        <button class="action-button save-btn" title="Sauvegarder" style="display: none;">${v.check}</button>
                        <button class="action-button cancel-btn" title="Annuler" style="display: none;">${v.x}</button>
                    </div>
                </h3>
                <div class="content">
                    <p class="editable-text short-text">${b(n.Description_courte||n.Desc_wpt||"")}</p>
                    <input type="text" class="editable-input" style="display: none;" placeholder="R√©sum√© pour l'export GPX..." maxlength="250">
                </div>
            </div>
            <div class="detail-section editable-field description-section" data-field-id="description">
                <h3>Description
                    <div class="edit-controls section-controls">
                        <button class="action-button speak-btn" title="Lire la description">${v.volume}</button>
                        <button class="action-button edit-btn" title="√âditer">${v.pen}</button>
                    </div>
                </h3>
                <div class="content">
                    <div class="description-content editable-text">${(n.description||n.Description||"").replace(/\n/g,"<br>")}</div>
                    ${xe(n)}
                </div>
            </div>
            ${S}
            <div class="detail-section">
                <h3>Mon Suivi</h3>
                <div class="content checkbox-group">
                  <label class="checkbox-label"><input type="checkbox" id="panel-chk-vu" ${u}> Visit√©</label>
                  <label class="checkbox-label"><input type="checkbox" id="panel-chk-incontournable" ${p}> Incontournable</label>
                  <label class="checkbox-label"><input type="checkbox" id="panel-chk-verified" ${m}> V√©rifi√©</label>
                </div>
            </div>
            <div class="detail-section editable-field notes-section" data-field-id="notes">
                <h3>Notes Personnelles
                    <div class="edit-controls section-controls">
                        <button class="action-button speak-btn" title="Lire les notes">${v.volume}</button>
                        <button class="action-button edit-btn" title="√âditer">${v.pen}</button>
                    </div>
                </h3>
                <div class="content">
                    <div class="description-content editable-text">${(n.notes||"").replace(/\n/g,"<br>")}</div>
                </div>
            </div>
            <div class="detail-section photos-section">
                <h3>Photos (${g.length})</h3>
                <div class="content">
                    <div class="photos-grid-scroller">
                        ${y}
                        <div class="photo-placeholder" title="Ajouter une photo">${v.imagePlus}</div>
                    </div>
                    <input type="file" id="panel-photo-input" accept="image/*" multiple style="display: none;">
                </div>
            </div>
        </div>`;return M()?P:G}function E(e,t=null){if(e===void 0||e<0)return;M()||k.closePopup(),i.currentFeatureId=e,i.currentCircuitIndex=t;const n=i.loadedFeatures[e];if(!n)return;const o=M()?c.mobileMainContainer:c.detailsPanel;o.innerHTML=Et(n,t);const r=f(n);Ct(r),xt(r),M()?o.style.display="block":(c.rightSidebar.style.display="flex",q("details",!0))}function W(e=!1){window.speechSynthesis&&window.speechSynthesis.speaking&&window.speechSynthesis.cancel(),Pe()&&$e(),M()?e&&i.activeCircuitId?ve(i.activeCircuitId):H():i.isSelectionModeActive?q("circuit"):(c.rightSidebar.style.display="none",i.currentFeatureId=null)}function q(e,t=!1){!t&&window.speechSynthesis&&window.speechSynthesis.speaking&&window.speechSynthesis.cancel(),Pe()&&$e(),c.sidebarPanels.forEach(n=>n.classList.toggle("active",n.dataset.panel===e)),c.tabButtons.forEach(n=>n.classList.toggle("active",n.dataset.tab===e))}function Lt(){c.tabButtons.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;if(t==="details"&&i.currentFeatureId!==null){const n=i.currentCircuit.findIndex(o=>f(o)===f(i.loadedFeatures[i.currentFeatureId]));E(i.currentFeatureId,n!==-1?n:null)}else q(t)})})}function Ee(e){if(i.currentFeatureId===null)return;const t=document.getElementById("panel-time-display");let n=parseInt(t.dataset.hours,10)||0,o=parseInt(t.dataset.minutes,10)||0,r=n*60+o+e;r<0&&(r=0),n=Math.floor(r/60),o=r%60;const a=f(i.loadedFeatures[i.currentFeatureId]);A(a,"timeH",n),A(a,"timeM",o),t.textContent=`${String(n).padStart(2,"0")}h${String(o).padStart(2,"0")}`,t.dataset.hours=n,t.dataset.minutes=o}function ee(){const e=document.getElementById("zonesMenu");if(!e)return;const t=document.getElementById("zonesLabel");if(e.innerHTML="",!i.loadedFeatures||i.loadedFeatures.length===0){e.innerHTML="<button disabled>Aucune zone</button>";return}const n=i.loadedFeatures.filter(s=>{const l={...s.properties,...s.properties.userData};if(i.activeFilters.mosquees&&l.Cat√©gorie!=="Mosqu√©e"||i.activeFilters.vus&&l.vu&&!l.incontournable)return!1;const d=(l.planifieCounter||0)>0;return!(i.activeFilters.planifies&&d&&!l.incontournable)}),o=n.reduce((s,l)=>{const d=l.properties.Zone;return d&&(s[d]=(s[d]||0)+1),s},{}),r=Object.keys(o).sort();if(r.length===0){e.innerHTML="<button disabled>Aucune zone visible</button>";return}const a=document.createElement("button");a.textContent=`Toutes les zones (${n.length})`,a.onclick=()=>{i.activeFilters.zone=null,t.textContent="Zone",e.style.display="none",x()},e.appendChild(a),r.forEach(s=>{const l=document.createElement("button");l.textContent=`${s} (${o[s]})`,l.onclick=()=>{i.activeFilters.zone=s,t.textContent=s,e.style.display="none",x()},e.appendChild(l)})}function St(){Ae(),c.circuitsModal.style.display="flex"}function se(){c.circuitsModal.style.display="none"}function Ae(){c.circuitsListContainer.innerHTML=i.myCircuits.length===0?'<p class="empty-list-info">Aucun circuit sauvegard√© pour cette carte.</p>':i.myCircuits.map(e=>`
            <div class="circuit-item" data-id="${e.id}">
                <span class="circuit-item-name">${b(e.name)}</span>
                <div class="circuit-item-actions">
                    <button class="btn-import" data-action="import" title="Importer un trac√© r√©el">${v.upload}</button>
                    <button class="btn-load" data-action="load" title="Charger le circuit">${v.play}</button>
                    <button class="btn-delete" data-action="delete" title="Supprimer le circuit">${v.trash}</button>
                </div>
            </div>`).join("")}async function Mt(e){const t=e.target.closest("button");if(!t)return;const o=t.closest(".circuit-item").dataset.id,r=t.dataset.action;r==="load"?(await Oe(o),se()):r==="delete"?await Dt(o):r==="import"&&(i.circuitIdToImportFor=o,c.gpxImporter.click())}async function Dt(e){if(confirm("√ätes-vous s√ªr de vouloir supprimer ce circuit ? Cette action est irr√©versible."))try{await Le(e),i.myCircuits=i.myCircuits.filter(t=>t.id!==e),i.activeCircuitId===e&&await Z(!1),await he(i.currentMapId),Ae(),M()||x(),h("Circuit supprim√© avec succ√®s.","success")}catch(t){console.error("Erreur lors de la suppression du circuit :",t),h("Erreur lors de la suppression du circuit.","error")}}function h(e,t="info",n=4e3){const o=document.getElementById("toast-container");if(!o)return;const r=document.createElement("div");r.className=`toast toast-${t}`;let a="";t==="success"?a='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>':t==="error"?a='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>':t==="warning"?a='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>':a='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',r.innerHTML=`${a}<span>${e}</span>`,o.appendChild(r),setTimeout(()=>{r.style.animation="fadeOut 0.5s forwards",r.addEventListener("animationend",()=>r.remove())},n-500)}async function J(){if(i.currentMapId)try{const e={poiIds:i.currentCircuit.map(f).filter(Boolean),description:c.circuitDescription.value,transport:{allerTemps:document.getElementById("transport-aller-temps").value,allerCout:document.getElementById("transport-aller-cout").value,retourTemps:document.getElementById("transport-retour-temps").value,retourCout:document.getElementById("transport-retour-cout").value}};await I(`circuitDraft_${i.currentMapId}`,e)}catch(e){console.error("Erreur lors de la sauvegarde du brouillon:",e)}}async function $t(){if(!(!i.currentMapId||i.loadedFeatures.length===0))try{const e=await O(`circuitDraft_${i.currentMapId}`);if(e&&Array.isArray(e.poiIds)&&e.poiIds.length>0){i.currentCircuit=e.poiIds.map(n=>i.loadedFeatures.find(o=>f(o)===n)).filter(Boolean);const t=fe();c.circuitTitleText.textContent=t,c.circuitDescription.value=e.description||"",e.transport&&(document.getElementById("transport-aller-temps").value=e.transport.allerTemps||"",document.getElementById("transport-aller-cout").value=e.transport.allerCout||"",document.getElementById("transport-retour-temps").value=e.transport.retourTemps||"",document.getElementById("transport-retour-cout").value=e.transport.retourCout||""),i.currentCircuit.length>0&&(i.isSelectionModeActive?_():X())}}catch(e){console.error("Erreur lors du chargement du brouillon sauvegard√©:",e),await I(`circuitDraft_${i.currentMapId}`,null)}}function X(){i.isSelectionModeActive=!i.isSelectionModeActive,c.btnModeSelection.classList.toggle("active",i.isSelectionModeActive),i.isSelectionModeActive?(k.closePopup(),c.rightSidebar.style.display="flex",q("circuit"),_()):(c.rightSidebar.style.display="none",i.orthodromicPolyline&&i.orthodromicPolyline.remove(),i.realTrackPolyline&&i.realTrackPolyline.remove()),x()}function je(e){if(!(i.currentCircuit.length>0&&f(e)===f(i.currentCircuit[i.currentCircuit.length-1]))){if(i.currentCircuit.length>=U){h(`Maximum de ${U} points atteint.`,"warning");return}c.rightSidebar.style.display==="flex"&&document.querySelector("#details-panel.active")&&q("circuit"),i.currentCircuit.push(e),J(),_()}}function _(){c.circuitStepsList.innerHTML="";const e=document.getElementById("btn-loop-circuit");e.disabled=i.currentCircuit.length===0||i.currentCircuit.length>=U,document.getElementById("btn-export-gpx").disabled=i.currentCircuit.length===0,document.getElementById("btn-import-gpx").disabled=!i.activeCircuitId,i.currentCircuit.length===0?c.circuitStepsList.innerHTML='<p class="empty-list-info">Cliquez sur les lieux sur la carte pour les ajouter √† votre circuit.</p>':i.currentCircuit.forEach((t,n)=>{const o=C(t),r=document.createElement("div");r.className="step",r.innerHTML=`<div class="num">${n+1}</div><div class="step-main" title="${o}">${o}</div><div class="step-actions"><button class="stepbtn" data-action="up" title="Monter" ${n===0?"disabled":""}><i data-lucide="chevron-up"></i></button><button class="stepbtn" data-action="down" title="Descendre" ${n===i.currentCircuit.length-1?"disabled":""}><i data-lucide="chevron-down"></i></button><button class="stepbtn" data-action="remove" title="Retirer"><i data-lucide="trash-2"></i></button></div>`,r.querySelector(".step-actions").addEventListener("click",a=>{const s=a.target.closest("button");s&&Pt(s.dataset.action,n)}),r.querySelector(".step-main").addEventListener("click",()=>{const a=i.loadedFeatures.indexOf(t);E(a,n)}),c.circuitStepsList.appendChild(r)}),Tt(),qt(),lucide.createIcons()}function Pt(e,t){if(e==="up"&&t>0)[i.currentCircuit[t],i.currentCircuit[t-1]]=[i.currentCircuit[t-1],i.currentCircuit[t]];else if(e==="down"&&t<i.currentCircuit.length-1)[i.currentCircuit[t],i.currentCircuit[t+1]]=[i.currentCircuit[t+1],i.currentCircuit[t]];else if(e==="remove"){const n=i.currentCircuit[t];if(i.currentCircuit.splice(t,1),i.currentFeatureId!==null&&f(i.loadedFeatures[i.currentFeatureId])===f(n)&&(i.currentFeatureId=null,i.currentCircuitIndex=null,document.querySelector("#details-panel.active")))if(i.currentCircuit.length>0){const o=i.loadedFeatures.indexOf(i.currentCircuit[0]);E(o,0)}else q("circuit")}J(),_()}function Tt(e=!0){c.circuitPoiCount.textContent=`${i.currentCircuit.length}/${U}`;const t=document.getElementById("distance-icon");let n=0;const o=i.myCircuits.find(r=>r.id===i.activeCircuitId);if(o&&o.realTrack?(n=_t(o),t.setAttribute("data-lucide","footprints"),t.title="Distance du trac√© r√©el"):(n=Re(i.currentCircuit),t.setAttribute("data-lucide","bird"),t.title="Distance √† vol d'oiseau"),c.circuitDistance.textContent=(n/1e3).toFixed(1)+" km",lucide.createIcons(),e){const r=fe();c.circuitTitleText.textContent=r,c.circuitTitleText.title=r}}function fe(){if(i.currentCircuit.length===0)return"Nouveau Circuit";if(i.currentCircuit.length===1)return`D√©part de ${C(i.currentCircuit[0])}`;const e=C(i.currentCircuit[0]),t=C(i.currentCircuit[i.currentCircuit.length-1]);let n="";if(i.currentCircuit.length>2){const o=Math.floor((i.currentCircuit.length-1)/2);n=C(i.currentCircuit[o])}return f(i.currentCircuit[0])===f(i.currentCircuit[i.currentCircuit.length-1])?n&&e!==n?`Boucle autour de ${e} via ${n}`:`Boucle autour de ${e}`:n?`Circuit de ${e} √† ${t} via ${n}`:`Circuit de ${e} √† ${t}`}async function Z(e=!0){const t=async()=>{i.currentCircuit=[],i.activeCircuitId=null,i.currentCircuitIndex=null,c.circuitDescription.value="",document.getElementById("transport-aller-temps").value="",document.getElementById("transport-aller-cout").value="",document.getElementById("transport-retour-temps").value="",document.getElementById("transport-retour-cout").value="",await I(`circuitDraft_${i.currentMapId}`,null),_(),document.querySelector("#circuit-panel.active")&&(c.circuitTitleText.textContent="Nouveau Circuit")};e&&i.currentCircuit.length>0?confirm("Voulez-vous vraiment vider le brouillon du circuit ?")&&await t():e||await t()}function Y(e){if(i.currentCircuitIndex===null)return;const t=i.currentCircuitIndex+e;if(t>=0&&t<i.currentCircuit.length){const n=i.currentCircuit[t],o=i.loadedFeatures.indexOf(n);E(o,t)}}async function Oe(e){const t=i.myCircuits.find(n=>n.id===e);if(t&&(await Z(!1),i.activeCircuitId=e,c.circuitTitleText.textContent=t.name||"Circuit charg√©",c.circuitDescription.value=t.description||"",t.transport&&(document.getElementById("transport-aller-temps").value=t.transport.allerTemps||"",document.getElementById("transport-aller-cout").value=t.transport.allerCout||"",document.getElementById("transport-retour-temps").value=t.transport.retourTemps||"",document.getElementById("transport-retour-cout").value=t.transport.retourCout||""),i.currentCircuit=t.poiIds.map(n=>i.loadedFeatures.find(o=>f(o)===n)).filter(Boolean),i.isSelectionModeActive?_():X(),x(),i.currentCircuit.length>0)){const n=L.featureGroup(i.currentCircuit.map(o=>{const r=o.geometry.coordinates;return L.marker([r[1],r[0]])}));k.flyToBounds(n.getBounds().pad(.1))}}function Bt(){document.getElementById("btn-clear-circuit").addEventListener("click",()=>Z(!0)),document.getElementById("btn-export-gpx").addEventListener("click",Te),document.getElementById("btn-import-gpx").addEventListener("click",()=>{i.activeCircuitId&&(i.circuitIdToImportFor=i.activeCircuitId,c.gpxImporter.click())}),document.getElementById("close-circuit-panel-button").addEventListener("click",async()=>{i.currentCircuit.length>0?confirm("Voulez-vous vraiment fermer et effacer le brouillon du circuit ?")&&(await Z(!1),X()):X()}),document.getElementById("btn-loop-circuit").addEventListener("click",()=>{i.currentCircuit.length>0&&i.currentCircuit.length<U&&je(i.currentCircuit[0])}),c.circuitDescription.addEventListener("input",J),["transport-aller-temps","transport-aller-cout","transport-retour-temps","transport-retour-cout"].forEach(e=>{document.getElementById(e).addEventListener("change",J)})}let k;const Ft='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-binoculars-icon lucide-binoculars"><path d="M10 10h4"/><path d="M19 7V4a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v3"/><path d="M20 21a2 2 0 0 0 2-2v-3.851c0-1.39-2-2.962-2-4.829V8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v11a2 2 0 0 0 2 2z"/><path d="M 22 16 L 2 16"/><path d="M4 21a2 2 0 0 1-2-2v-3.851c0-1.39 2-2.962 2-4.829V8a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v11a2 2 0 0 1-2 2z"/><path d="M9 7V4a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1v3"/></svg>',At='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-amphora-icon lucide-amphora"><path d="M10 2v5.632c0 .424-.272.795-.653.982A6 6 0 0 0 6 14c.006 4 3 7 5 8"/><path d="M10 5H8a2 2 0 0 0 0 4h.68"/><path d="M14 2v5.632c0 .424.272.795.652.982A6 6 0 0 1 18 14c0 4-3 7-5 8"/><path d="M14 5h2a2 2 0 0 1 0 4h-.68"/><path d="M18 22H6"/><path d="M9 2h6"/></svg>',Ne={Mosqu√©e:"landmark","Site historique":"castle","Culture et tradition":At,Curiosit√©:Ft,H√¥tel:"hotel","Site religieux":"church"};function jt(){k=L.map("map",{zoomSnap:.25,zoomDelta:.25,wheelPxPerZoomLevel:180,attributionControl:!1}).setView([33.8076,10.8451],11);const e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}),t=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",maxZoom:18});e.addTo(k);const n={Plan:e,Satellite:t};L.control.layers(n).addTo(k),L.control.attribution({position:"bottomleft"}).addTo(k)}function Ot(e){const n=Ne[e]||"map-pin";let o;return n.startsWith("<svg")?o=n:o=`<i data-lucide="${n}"></i>`,L.divIcon({html:`<div class="hw-icon-wrapper">${o}</div>`,className:"hw-icon",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})}function Nt(e){const t="map-pin",n=e.properties.Cat√©gorie,o=Ne[n]||t;return o.startsWith("<svg")?o:`<i data-lucide="${o}"></i>`}function Rt(e){je(e)}function Ht(e){let t=0;for(let n=0;n<e.length-1;n++)t+=L.latLng(e[n]).distanceTo(L.latLng(e[n+1]));return t}function qt(){if(i.orthodromicPolyline&&i.orthodromicPolyline.remove(),i.realTrackPolyline&&i.realTrackPolyline.remove(),i.currentCircuit.length<2)return;const e=i.myCircuits.find(t=>t.id===i.activeCircuitId);if(e&&e.realTrack)i.realTrackPolyline=L.polyline(e.realTrack,{className:"real-track-polyline"}).addTo(k);else{const t=i.currentCircuit.map(n=>{const[o,r]=n.geometry.coordinates;return[r,o]});i.orthodromicPolyline=L.polyline(t,{className:"circuit-polyline"}).addTo(k)}}function _t(e){return!e||!e.realTrack?0:Ht(e.realTrack)}function Re(e){if(e.length<2)return 0;let t=0;for(let n=0;n<e.length-1;n++){const o=e[n].geometry.coordinates,r=e[n+1].geometry.coordinates;t+=L.latLng(o[1],o[0]).distanceTo(L.latLng(r[1],r[0]))}return t}let F=null;const Gt=["Mosqu√©e","Site historique","Curiosit√©","H√¥tel","Restaurant","Caf√©","Taxi","Commerce"];async function Vt(){const e="Djerba.geojson";c.loaderOverlay.style.display="flex";try{const t=await fetch(e);if(!t.ok)throw new Error(`Le r√©seau a r√©pondu avec une erreur: ${t.statusText}`);const n=await t.json();await me(n,"Djerba"),c.btnSaveData.disabled=!1,c.btnRestoreData.disabled=!1,h("Carte de Djerba charg√©e par d√©faut.","success")}catch(t){console.error("Impossible de charger la carte par d√©faut:",t),h("Impossible de charger la carte. Veuillez la s√©lectionner manuellement.","error"),c.btnSaveData.disabled=!0,c.btnRestoreData.disabled=!0}finally{c.loaderOverlay.style.display="none"}}async function zt(){document.getElementById("app-version").textContent=Se,bt();try{await D(),console.log("Connexion √† IndexedDB r√©ussie.");const e=await O("currentTheme");e&&document.documentElement.setAttribute("data-theme",e),M()?rt():Ut()}catch(e){console.error("√âchec de l'initialisation de l'application:",e),document.body.innerHTML=`<h1>Erreur critique</h1><p>Impossible d'initialiser l'application. Veuillez v√©rifier la console pour plus de d√©tails.</p><p>${e.message}</p>`}}async function Ut(){jt(),typeof k<"u"&&Qt(k),Wt();const e=await O("lastMapId"),t=await O("lastGeoJSON"),n=document.getElementById("btn-import-photos"),o=document.getElementById("photo-gps-loader");n&&o&&(n.addEventListener("click",()=>o.click()),o.addEventListener("change",Kt)),e&&t?(c.btnSaveData.disabled=!1,c.btnRestoreData.disabled=!1,await me(t,e)):await Vt()}function Wt(){c.btnOpenGeojson.addEventListener("click",()=>c.geojsonLoader.click()),c.btnModeSelection.addEventListener("click",X),c.btnMyCircuits.addEventListener("click",St),document.getElementById("btn-filter-mosquees")?.addEventListener("click",e=>{const t=e.currentTarget.classList.toggle("active");i.activeFilters.mosquees=t,x(),ee()}),document.getElementById("btn-filter-vus")?.addEventListener("click",e=>{const t=e.currentTarget.classList.toggle("active");i.activeFilters.vus=t,e.currentTarget.innerHTML=t?'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.6 11.2c.4.8.6 1.7.6 2.8c0 4.4-4 8-9 8s-9-3.6-9-8c0-1.1.2-2 .6-2.8"/><path d="M7.6 7.6C5.6 9.2 4 11.2 4 14c0 4.4 4 8 9 8s9-3.6 9-8c0-2.8-1.6-4.8-3.6-6.4"/><path d="M12.5 9.5c.6.6 1.2 1.5 1.5 2.5"/><path d="m2 2 20 20"/><path d="M9.5 5.5c.3-1 .9-1.8 1.5-2.5"/></svg><span>Visit√©s</span>':'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg><span>Visit√©s</span>',x(),ee()}),document.getElementById("btn-filter-planifies")?.addEventListener("click",e=>{const t=e.currentTarget.classList.toggle("active");i.activeFilters.planifies=t,e.currentTarget.innerHTML=t?'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><line x1="2" x2="22" y1="2" y2="22"/></svg><span>Planifi√©s</span>':'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg><span>Planifi√©s</span>',x(),ee()}),document.getElementById("btn-filter-zones")?.addEventListener("click",e=>{e.stopPropagation(),document.getElementById("zonesMenu").style.display=document.getElementById("zonesMenu").style.display==="none"?"block":"none"}),document.addEventListener("click",e=>{if(!e.target.closest(".zones-container")){const t=document.getElementById("zonesMenu");t&&(t.style.display="none")}}),document.getElementById("btn-theme-selector").addEventListener("click",()=>{const e=["maritime","desert","oasis","night"],t=document.documentElement.getAttribute("data-theme")||"maritime",o=(e.indexOf(t)+1)%e.length,r=e[o];document.documentElement.setAttribute("data-theme",r),I("currentTheme",r)}),c.btnSaveData.addEventListener("click",He),c.btnRestoreData.addEventListener("click",()=>{c.btnRestoreData.disabled||c.restoreLoader.click()}),c.restoreLoader.addEventListener("change",ce),c.geojsonLoader.addEventListener("change",Xt),c.searchInput.addEventListener("input",Jt),c.searchInput.addEventListener("keydown",e=>{if(e.key==="Enter"){const t=c.searchInput.value.trim();console.log("Touche Entr√©e d√©tect√©e. Recherche :",t);const n=/^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/,o=t.match(n);if(o){const r=parseFloat(o[1]),a=parseFloat(o[3]);console.log("Coordonn√©es valides :",r,a);const s=typeof k<"u"?k:window.map;s?(s.flyTo([r,a],18,{duration:1.5}),c.searchResults.style.display="none"):console.error("Erreur : La carte est introuvable pour le zoom.")}}}),document.addEventListener("click",e=>{e.target.closest(".search-container")||(c.searchResults.style.display="none")}),Lt(),Bt(),c.closeCircuitsModal.addEventListener("click",se),c.circuitsModal.addEventListener("click",e=>{e.target===c.circuitsModal&&se()}),c.circuitsListContainer.addEventListener("click",Mt),c.gpxImporter.addEventListener("change",Zt)}function Jt(){const e=c.searchInput.value.toLowerCase().trim();if(c.searchResults.innerHTML="",c.searchResults.style.display="none",e.length===0)return;const t=i.loadedFeatures.filter(n=>{const o=f(n);if(i.hiddenPoiIds&&i.hiddenPoiIds.includes(o))return!1;const r=n.properties["Nom du site FR"]?.toLowerCase()||"",a=n.properties.userData?.custom_title?.toLowerCase()||"";return r.includes(e)||a.includes(e)});t.length>0&&(t.slice(0,10).forEach(n=>{const o=document.createElement("button");o.textContent=C(n),o.addEventListener("click",()=>{c.searchInput.value="",c.searchResults.style.display="none",i.geojsonLayer.eachLayer(a=>{a.feature===n&&k.flyTo(a.getLatLng(),16)});const r=i.loadedFeatures.indexOf(n);if(r>-1){const a=i.currentCircuit.findIndex(s=>f(s)===f(n));E(r,a!==-1?a:null)}}),c.searchResults.appendChild(o)}),c.searchResults.style.display="block")}async function Xt(e){const t=e.target.files[0];t&&(c.loaderOverlay.style.display="flex",setTimeout(async()=>{const n=new FileReader;n.onload=async o=>{try{const r=o.target.result,a=t.name.replace(/\.geojson$|\.json$/i,""),s=JSON.parse(r);await I("lastMapId",a),await I("lastGeoJSON",s),await Z(!1),await me(s,a),c.btnSaveData.disabled=!1,c.btnRestoreData.disabled=!1,M()&&location.reload()}catch(r){console.error("Erreur GeoJSON:",r),h("Fichier GeoJSON invalide.","error"),c.btnSaveData.disabled=!0,c.btnRestoreData.disabled=!0}finally{c.loaderOverlay.style.display="none"}},n.readAsText(t),e.target.value=""},50))}async function Zt(e){const t=e.target.files[0];if(!t||!i.circuitIdToImportFor)return;const n=new FileReader;n.onload=async o=>{try{const r=o.target.result;if(!r.includes(`[HW-ID:${i.circuitIdToImportFor}]`)){h("Erreur : L'ID de ce GPX ne correspond pas au circuit.","error");return}const a=new DOMParser().parseFromString(r,"text/xml"),s=Array.from(a.querySelectorAll("trkpt"));if(s.length===0){h("Aucun point de trac√© trouv√© dans ce GPX.","warning");return}const l=s.map(u=>[parseFloat(u.getAttribute("lat")),parseFloat(u.getAttribute("lon"))]),d=i.myCircuits.findIndex(u=>u.id===i.circuitIdToImportFor);d>-1&&(i.myCircuits[d].realTrack=l,await ue(i.myCircuits[d]),h(`Trac√© r√©el import√© pour "${i.myCircuits[d].name}".`,"success"),i.activeCircuitId===i.circuitIdToImportFor&&await Oe(i.activeCircuitId))}catch(r){console.error("Erreur lors de l'import GPX:",r),h("Erreur √† la lecture du fichier GPX.","error")}finally{i.circuitIdToImportFor=null,e.target.value=""}},n.readAsText(t)}async function Kt(e){const t=Array.from(e.target.files);if(!(!t||t.length===0)){c.loaderOverlay.style.display="flex";try{let n=[];const o=[];for(let u of t)try{const p=await Ve(u);p?(n.push(p),o.push({file:u,coords:p})):o.push({file:u,coords:null})}catch{o.push({file:u,coords:null})}if(n.length===0)throw new Error("GPS_MISSING");const r=n.reduce((u,p)=>u+p.lat,0)/n.length,a=n.reduce((u,p)=>u+p.lng,0)/n.length,s=typeof k<"u"?k:window.map;s&&s.flyTo([r,a],18,{duration:1.5});let l=null,d=100;if(i.loadedFeatures.forEach(u=>{if(u.geometry&&u.geometry.coordinates){const[p,m]=u.geometry.coordinates,g=we(r,a,m,p);g<d&&(d=g,l=u)}}),l){const u=l.properties["Nom du site FR"]||l.properties.name||"Lieu inconnu";if(confirm(`üìç Lieu existant d√©tect√© !
Cible : "${u}" (√† environ ${Math.round(d)}m du groupe de photos).

OK = AJOUTER les photos √† ce lieu.
Annuler = Cr√©er un NOUVEAU lieu.`)){let m=null;if(l.properties&&l.properties.HW_ID?m=String(l.properties.HW_ID):l.id&&(m=String(l.id)),!m){const[P,T]=l.geometry.coordinates;m=`auto_${Math.round(T*1e5)}_${Math.round(P*1e5)}`,l.properties||(l.properties={}),l.properties.HW_ID=m}i.userData[m]||(i.userData[m]={}),i.userData[m].photos||(i.userData[m].photos=[]);let g=0,y=0;const[S,$]=l.geometry.coordinates;for(let P of o){const T=P.file,V=P.coords;let ge=!0;if(V){const R=we(V.lat,V.lng,$,S);R>130&&(ge=confirm(`‚ö†Ô∏è Photo "${T.name}" loin du lieu (${Math.round(R)}m). Ajouter quand m√™me ?`))}if(ge)try{const R=await ze(T);i.userData[m].photos.push(R),g++}catch(R){console.error(R)}else y++}await de(i.currentMapId,m,i.userData[m]),c.loaderOverlay.style.display="none";let G=`${g} photo(s) ajout√©e(s).`;y>0&&(G+=` (${y} ignor√©e(s)).`),h(G,"success"),W(),setTimeout(()=>{const P=i.loadedFeatures.indexOf(l);P>-1&&E(P)},100)}else c.loaderOverlay.style.display="none",le(r,a,s)}else c.loaderOverlay.style.display="none",le(r,a,s),h("Aucun lieu proche identifi√©. Cr√©ation...","info")}catch(n){c.loaderOverlay.style.display="none",console.error("Erreur Import:",n),n.message==="GPS_MISSING"?alert("Impossible de localiser ces photos (GPS manquant sur l'ensemble du lot)."):alert("Erreur technique : "+n.message)}finally{e.target.value=""}}}async function He(){if(!i.currentMapId){h("Veuillez d'abord charger une carte.","warning");return}const e=M()?{type:"FeatureCollection",features:i.loadedFeatures}:await O("lastGeoJSON"),t=await te(i.currentMapId),n=await K(i.currentMapId),o={mapId:i.currentMapId,baseGeoJSON:e,userData:t,circuits:n},r=JSON.stringify(o,null,2),a=new Date,s=a.toISOString().slice(0,10),l=a.toTimeString().slice(0,8).replace(/:/g,"-"),d=`HistoryWalk_Backup_${i.currentMapId}_${s}_${l}.json`;try{const u=new File([r],d,{type:"application/json"});if(navigator.canShare&&navigator.canShare({files:[u]})){await navigator.share({files:[u],title:"Sauvegarde History Walk",text:`Sauvegarde des donn√©es du ${s}`}),h("Donn√©es envoy√©es avec succ√®s !","success");return}}catch(u){if(u.name==="AbortError")return;console.warn("Le partage natif a √©chou√©, bascule vers le t√©l√©chargement classique.",u)}pe(d,r,"application/json"),h("Sauvegarde t√©l√©charg√©e (M√©thode classique)","success")}async function ce(e){const t=e.target.files[0];t&&(c.loaderOverlay.style.display="flex",setTimeout(async()=>{const n=new FileReader;n.onload=async o=>{try{const r=JSON.parse(o.target.result);if(!i.currentMapId)throw new Error("Veuillez charger la carte de destination correspondante avant de restaurer.");if(r.mapId!==i.currentMapId)throw new Error(`Ce fichier est pour la carte "${r.mapId}", mais la carte actuelle est "${i.currentMapId}".`);if(!confirm(`Voulez-vous vraiment restaurer les donn√©es pour la carte "${r.mapId}" ?
Les donn√©es existantes seront mises √† jour.`)){c.loaderOverlay.style.display="none",e.target.value="";return}r.baseGeoJSON&&await I("lastGeoJSON",r.baseGeoJSON);for(const[s,l]of Object.entries(r.userData))await de(r.mapId,s,l);const a=await K(i.currentMapId);for(const s of a)await Le(s.id);for(const s of r.circuits)s.mapId=i.currentMapId,await ue(s);h("Restauration termin√©e. L'application va se recharger.","success"),setTimeout(()=>location.reload(),1500)}catch(r){console.error("Erreur de restauration:",r),h(r.message,"error")}finally{c.loaderOverlay.style.display="none",e.target.value=""}},n.readAsText(t)},50))}function Qt(e){window.map=e,e.on("contextmenu",t=>{const{lat:n,lng:o}=t.latlng;F?F.setLatLng(t.latlng):le(n,o,e)})}function le(e,t,n){F=L.marker([e,t],{draggable:!0,title:"D√©placez-moi pour ajuster"}).addTo(n);const o=document.createElement("div");o.style.textAlign="center",o.innerHTML=`
        <div style="font-weight:bold; margin-bottom:5px;">Nouveau Lieu ?</div>
        <div style="font-size:12px; color:#666; margin-bottom:8px;">Glissez pour ajuster.</div>
        <button id="btn-validate-desktop-poi" class="action-btn" style="background:var(--brand); color:white; padding:4px 8px; font-size:12px; cursor:pointer;">
            Valider cette position
        </button>
    `,F.bindPopup(o,{minWidth:200}).openPopup();const r=a=>{if(a.target&&a.target.id==="btn-validate-desktop-poi"){const s=F.getLatLng();Yt(s.lat,s.lng),n.removeLayer(F),F=null,document.body.removeEventListener("click",r)}};document.body.addEventListener("click",r),F.on("dragend",()=>F.openPopup())}function Yt(e,t){const n=document.getElementById("add-poi-modal");if(!n){alert("Erreur: La modale 'add-poi-modal' n'est pas dans le HTML.");return}const o=document.getElementById("new-poi-coords"),r=document.getElementById("new-poi-name"),a=document.getElementById("new-poi-category"),s=document.getElementById("btn-confirm-add-poi"),l=document.getElementById("close-add-poi-modal");r.value="",o.textContent=`${e.toFixed(6)}, ${t.toFixed(6)}`,a.innerHTML="";const d=new Set(i.loadedFeatures.map(y=>y.properties.Cat√©gorie).filter(Boolean)),u=new Set([...Gt,...d]);Array.from(u).sort().forEach(y=>{const S=document.createElement("option");S.value=y,S.textContent=y,y==="Mosqu√©e"&&i.currentMapId?.includes("Djerba")&&(S.selected=!0),a.appendChild(S)}),n.style.display="flex",r.focus();const p=s.cloneNode(!0);s.parentNode.replaceChild(p,s),p.addEventListener("click",async()=>{const y=r.value.trim(),S=a.value;if(!y)return h("Nom requis","warning");const $=`HW-PC-${Date.now()}`;De({type:"Feature",geometry:{type:"Point",coordinates:[t,e]},properties:{"Nom du site FR":y,Cat√©gorie:S,Zone:"A d√©finir (PC)",Description:"Ajout√© depuis PC",HW_ID:$}}),await I("lastGeoJSON",{type:"FeatureCollection",features:i.loadedFeatures}),await ne($,"Cr√©ation PC","All",null,"Nouveau lieu PC"),h(`Lieu "${y}" ajout√© !`,"success"),n.style.display="none"});const m=()=>{n.style.display="none"},g=l.cloneNode(!0);l.parentNode.replaceChild(g,l),g.addEventListener("click",m)}document.addEventListener("DOMContentLoaded",zt);window.requestSoftDelete=function(e){let t;if(typeof e=="number"&&i.loadedFeatures[e]?t=i.loadedFeatures[e]:t=i.loadedFeatures[i.currentFeatureId],!t)return;let n;try{n=f(t)}catch{n=t.properties.HW_ID||t.id}const o=t.properties["Nom du site FR"]||t.properties["Nom du site AR"]||"ce lieu";confirm(`ATTENTION !

Voulez-vous vraiment signaler "${o}" pour suppression ?

Ce lieu dispara√Ætra imm√©diatement de votre carte.`)&&(i.hiddenPoiIds||(i.hiddenPoiIds=[]),i.hiddenPoiIds.includes(n)||i.hiddenPoiIds.push(n),localStorage.setItem("djerba_hidden_pois",JSON.stringify(i.hiddenPoiIds)),typeof db<"u"&&db.logChange&&db.logChange(n,"STATUS","ACTIVE","DELETED"),typeof W=="function"&&W(),typeof x=="function"?x():location.reload())};"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(function(e){for(let t of e)t.unregister().then(function(n){console.log("Ancien Service Worker d√©sinscrit avec succ√®s.")})});
